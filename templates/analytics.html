{% extends "base.html" %}

{% block title %}Advanced Analytics | Personal Finance Tracker{% endblock %}

{% block head %}
<style>
    .analytics-header {
        background: linear-gradient(135deg, var(--primary) 0%, #8b5cf6 100%);
        color: white;
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 1.5rem;
        border: 2px solid rgba(255, 255, 255, 0.2);
    }
    
    .analytics-title {
        font-size: 1.75rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .analytics-subtitle {
        opacity: 0.9;
        font-size: 1rem;
    }
    
    /* Quick View Chips */
    .analytics-chips {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-bottom: 1.5rem;
    }
    
    .analytics-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border-color);
        color: var(--text-muted);
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .analytics-chip:hover {
        background: rgba(129, 140, 248, 0.15);
        border-color: var(--primary);
        color: var(--text-primary);
    }
    
    .analytics-chip.active {
        background: rgba(129, 140, 248, 0.25);
        border-color: var(--primary);
        color: var(--text-primary);
    }
    
    .analytics-chip i {
        font-size: 1rem;
    }
    
    .analytics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
        gap: 1.5rem;
    }
    
    .analytics-card {
        background: var(--bg-card);
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        border: 2px solid rgba(255, 255, 255, 0.15);
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .analytics-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(0,0,0,0.4);
    }
    
    .analytics-card-header {
        padding: 1rem 1.25rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .analytics-card-header.health { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
    .analytics-card-header.anomalies { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; }
    .analytics-card-header.predictions { background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); color: white; }
    .analytics-card-header.insights { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; }
    .analytics-card-header.trends { background: linear-gradient(135deg, #ec4899 0%, #be185d 100%); color: white; }
    
    .analytics-card-body {
        padding: 1.25rem;
    }
    
    .score-display {
        text-align: center;
        padding: 1rem 0;
    }
    
    .score-circle {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        background: rgba(16, 185, 129, 0.1);
        border: 4px solid #10b981;
    }
    
    .score-circle.good { border-color: #10b981; }
    .score-circle.fair { border-color: #f59e0b; }
    .score-circle.poor { border-color: #ef4444; }
    
    .score-number {
        font-size: 2rem;
        font-weight: 700;
        line-height: 1;
    }
    
    .score-grade {
        font-size: 1.1rem;
        font-weight: 600;
        opacity: 0.8;
    }
    
    .score-status {
        font-size: 1rem;
        font-weight: 600;
    }
    
    .factor-item {
        background: rgba(255,255,255,0.5);
        padding: 0.75rem;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        border-left: 3px solid #e5e7eb;
    }
    
    .factor-item.good { border-left-color: #10b981; }
    .factor-item.fair { border-left-color: #f59e0b; }
    .factor-item.poor { border-left-color: #ef4444; }
    
    .factor-name {
        font-size: 0.85rem;
        color: var(--text-secondary);
    }
    
    .factor-score {
        font-weight: 600;
        font-size: 0.9rem;
    }
    
    .progress-mini {
        height: 4px;
        border-radius: 2px;
        background: rgba(0,0,0,0.1);
        margin-top: 0.25rem;
    }
    
    .progress-mini-bar {
        height: 100%;
        border-radius: 2px;
        transition: width 0.3s ease;
    }
    
    .recommendation-item {
        background: rgba(99, 102, 241, 0.1);
        padding: 0.75rem;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        border-left: 3px solid var(--primary);
    }
    
    .anomaly-item {
        padding: 0.75rem;
        border-radius: 8px;
        margin-bottom: 0.75rem;
        border-left: 4px solid;
    }
    
    .anomaly-item.high {
        background: rgba(239, 68, 68, 0.1);
        border-left-color: #ef4444;
    }
    
    .anomaly-item.medium {
        background: rgba(245, 158, 11, 0.1);
        border-left-color: #f59e0b;
    }
    
    .anomaly-title {
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
    }
    
    .anomaly-details {
        font-size: 0.8rem;
        color: var(--text-secondary);
    }
    
    .anomaly-badge {
        display: inline-block;
        padding: 0.15rem 0.5rem;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .anomaly-badge.high { background: #ef4444; color: white; }
    .anomaly-badge.medium { background: #f59e0b; color: white; }
    
    .prediction-item {
        background: rgba(6, 182, 212, 0.05);
        padding: 0.75rem;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .prediction-month {
        font-weight: 600;
    }
    
    .prediction-amount {
        font-size: 1.1rem;
        font-weight: 700;
        color: #06b6d4;
    }
    
    .prediction-range {
        font-size: 0.75rem;
        color: var(--text-secondary);
    }
    
    .insight-item {
        padding: 0.75rem;
        border-radius: 8px;
        margin-bottom: 0.75rem;
        background: rgba(139, 92, 246, 0.05);
        border-left: 3px solid #8b5cf6;
    }
    
    .insight-title {
        font-weight: 600;
        margin-bottom: 0.25rem;
    }
    
    .insight-description {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-bottom: 0.5rem;
    }
    
    .insight-recommendation {
        font-size: 0.8rem;
        padding: 0.5rem;
        background: rgba(139, 92, 246, 0.1);
        border-radius: 4px;
    }
    
    .stat-row {
        display: flex;
        justify-content: space-around;
        text-align: center;
        padding: 1rem 0;
        border-bottom: 1px solid rgba(0,0,0,0.05);
        margin-bottom: 1rem;
    }
    
    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
    }
    
    .stat-label {
        font-size: 0.75rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .empty-state {
        text-align: center;
        padding: 2rem;
        color: var(--text-secondary);
    }
    
    .empty-state i {
        font-size: 2.5rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    .loading-spinner {
        display: inline-block;
        width: 1.5rem;
        height: 1.5rem;
        border: 2px solid rgba(255,255,255,0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .refresh-btn {
        background: rgba(255,255,255,0.2);
        border: 1px solid rgba(255,255,255,0.3);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .refresh-btn:hover {
        background: rgba(255,255,255,0.3);
    }
    
    /* Category Badges for Trends */
    .trend-category-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.25rem 0.6rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
        color: white;
    }
    
    .trend-category-badge.food { background: linear-gradient(135deg, #f97316, #ea580c); }
    .trend-category-badge.transportation { background: linear-gradient(135deg, #3b82f6, #2563eb); }
    .trend-category-badge.housing { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
    .trend-category-badge.entertainment { background: linear-gradient(135deg, #ec4899, #db2777); }
    .trend-category-badge.shopping { background: linear-gradient(135deg, #14b8a6, #0d9488); }
    .trend-category-badge.financial { background: linear-gradient(135deg, #6366f1, #4f46e5); }
    .trend-category-badge.health { background: linear-gradient(135deg, #22c55e, #16a34a); }
    .trend-category-badge.income { background: linear-gradient(135deg, #10b981, #059669); }
    .trend-category-badge.travel { background: linear-gradient(135deg, #06b6d4, #0891b2); }
    .trend-category-badge.other { background: linear-gradient(135deg, #64748b, #475569); }
    
    /* Mobile Card View for Trends */
    .trend-mobile-card {
        display: none;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 0.75rem;
    }
    
    .trend-mobile-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }
    
    .trend-mobile-amounts {
        display: flex;
        justify-content: space-between;
        font-size: 0.9rem;
        color: var(--text-muted);
    }
    
    .trend-mobile-change {
        font-weight: 600;
        font-size: 1.1rem;
    }
    
    /* Summary Stats Row */
    .analytics-summary {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .analytics-stat-card {
        background: var(--bg-card);
        border: 2px solid rgba(255, 255, 255, 0.15);
        border-radius: 12px;
        padding: 1.25rem;
        text-align: center;
        transition: transform 0.2s;
    }
    
    .analytics-stat-card:hover {
        transform: translateY(-2px);
    }
    
    .analytics-stat-icon {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
    }
    
    .analytics-stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
    }
    
    .analytics-stat-label {
        font-size: 0.75rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    /* Trend Table Styling */
    .trends-table {
        width: 100%;
        font-size: 0.9rem;
    }
    
    .trends-table thead {
        position: sticky;
        top: 0;
        background: var(--bg-card);
    }
    
    .trends-table th {
        text-align: left;
        padding: 0.75rem;
        font-weight: 600;
        color: var(--text-muted);
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 1px solid var(--border-color);
    }
    
    .trends-table td {
        padding: 0.75rem;
        border-bottom: 1px solid var(--border-color);
    }
    
    .trends-table tr:hover {
        background: rgba(129, 140, 248, 0.08);
    }
    
    @media (max-width: 768px) {
        .analytics-grid {
            grid-template-columns: 1fr;
        }
        
        .analytics-summary {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .analytics-chips {
            overflow-x: auto;
            flex-wrap: nowrap;
            padding-bottom: 0.5rem;
            -webkit-overflow-scrolling: touch;
        }
        
        .analytics-chip {
            flex-shrink: 0;
        }
        
        .trends-table-container {
            display: none;
        }
        
        .trend-mobile-card {
            display: block;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="analytics-header">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div>
            <h1 class="analytics-title">
                <i class="bi bi-graph-up-arrow me-2"></i>Advanced Analytics
            </h1>
            <p class="analytics-subtitle mb-0">AI-powered insights, predictions, and financial health analysis</p>
        </div>
        <button class="refresh-btn" onclick="loadAllAnalytics()">
            <i class="bi bi-arrow-clockwise me-1"></i>Refresh
        </button>
    </div>
</div>

<!-- Quick View Chips -->
<div class="analytics-chips">
    <span class="analytics-chip active" onclick="scrollToCard('health-card')">
        <i class="bi bi-heart-pulse"></i> Health Score
    </span>
    <span class="analytics-chip" onclick="scrollToCard('anomalies-card')">
        <i class="bi bi-exclamation-triangle"></i> Anomalies
    </span>
    <span class="analytics-chip" onclick="scrollToCard('predictions-card')">
        <i class="bi bi-graph-up"></i> Predictions
    </span>
    <span class="analytics-chip" onclick="scrollToCard('insights-card')">
        <i class="bi bi-lightbulb"></i> Insights
    </span>
    <span class="analytics-chip" onclick="scrollToCard('trends-card')">
        <i class="bi bi-bar-chart-line"></i> Trends
    </span>
    <span class="analytics-chip" onclick="scrollToCard('merchants-card')">
        <i class="bi bi-shop"></i> Merchants
    </span>
    <span class="analytics-chip" onclick="scrollToCard('patterns-card')">
        <i class="bi bi-calendar-week"></i> Patterns
    </span>
    <span class="analytics-chip" onclick="scrollToCard('breakdown-card')">
        <i class="bi bi-pie-chart"></i> Breakdown
    </span>
    <span class="analytics-chip" onclick="scrollToCard('recurring-card')">
        <i class="bi bi-arrow-repeat"></i> Recurring
    </span>
</div>

<!-- Summary Stats -->
<div class="analytics-summary" id="analytics-summary">
    <div class="analytics-stat-card">
        <div class="analytics-stat-icon">üí∞</div>
        <div class="analytics-stat-value" id="summary-score">--</div>
        <div class="analytics-stat-label">Health Score</div>
    </div>
    <div class="analytics-stat-card">
        <div class="analytics-stat-icon">‚ö†Ô∏è</div>
        <div class="analytics-stat-value" id="summary-anomalies">--</div>
        <div class="analytics-stat-label">Anomalies</div>
    </div>
    <div class="analytics-stat-card">
        <div class="analytics-stat-icon">üìà</div>
        <div class="analytics-stat-value" id="summary-increasing">--</div>
        <div class="analytics-stat-label">Categories Up</div>
    </div>
    <div class="analytics-stat-card">
        <div class="analytics-stat-icon">üìâ</div>
        <div class="analytics-stat-value" id="summary-decreasing">--</div>
        <div class="analytics-stat-label">Categories Down</div>
    </div>
</div>

<!-- Analytics Grid -->
<div class="analytics-grid">
    <!-- Financial Health Score -->
    <div class="analytics-card" id="health-card">
        <div class="analytics-card-header health">
            <i class="bi bi-heart-pulse"></i>Financial Health Score
        </div>
        <div class="analytics-card-body" id="health-content">
            <div class="empty-state">
                <div class="loading-spinner"></div>
                <p>Calculating your financial health...</p>
            </div>
        </div>
    </div>
    
    <!-- Spending Anomalies -->
    <div class="analytics-card" id="anomalies-card">
        <div class="analytics-card-header anomalies">
            <i class="bi bi-exclamation-triangle"></i>Spending Anomalies
        </div>
        <div class="analytics-card-body" id="anomalies-content">
            <div class="empty-state">
                <div class="loading-spinner"></div>
                <p>Detecting unusual patterns...</p>
            </div>
        </div>
    </div>
    
    <!-- Spending Predictions -->
    <div class="analytics-card" id="predictions-card">
        <div class="analytics-card-header predictions">
            <i class="bi bi-graph-up"></i>Spending Predictions
        </div>
        <div class="analytics-card-body" id="predictions-content">
            <div class="empty-state">
                <div class="loading-spinner"></div>
                <p>Generating predictions...</p>
            </div>
        </div>
    </div>
    
    <!-- Spending Insights -->
    <div class="analytics-card" id="insights-card">
        <div class="analytics-card-header insights">
            <i class="bi bi-lightbulb"></i>Spending Insights
        </div>
        <div class="analytics-card-body" id="insights-content">
            <div class="empty-state">
                <div class="loading-spinner"></div>
                <p>Analyzing spending patterns...</p>
            </div>
        </div>
    </div>
    
    <!-- Category Trends -->
    <div class="analytics-card" id="trends-card" style="grid-column: 1 / -1;">
        <div class="analytics-card-header trends">
            <i class="bi bi-bar-chart-line"></i>Category Trends (3 Months)
        </div>
        <div class="analytics-card-body" id="trends-content">
            <div class="empty-state">
                <div class="loading-spinner"></div>
                <p>Analyzing category trends...</p>
            </div>
        </div>
    </div>
    
    <!-- Top Merchants -->
    <div class="analytics-card" id="merchants-card">
        <div class="analytics-card-header" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white;">
            <i class="bi bi-shop"></i>Top Merchants
        </div>
        <div class="analytics-card-body" id="merchants-content">
            <div class="empty-state">
                <div class="loading-spinner"></div>
                <p>Analyzing merchant spending...</p>
            </div>
        </div>
    </div>
    
    <!-- Spending Patterns -->
    <div class="analytics-card" id="patterns-card">
        <div class="analytics-card-header" style="background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); color: white;">
            <i class="bi bi-calendar-week"></i>Spending Patterns
        </div>
        <div class="analytics-card-body" id="patterns-content">
            <div class="empty-state">
                <div class="loading-spinner"></div>
                <p>Analyzing spending patterns...</p>
            </div>
        </div>
    </div>
    
    <!-- Category Breakdown -->
    <div class="analytics-card" id="breakdown-card">
        <div class="analytics-card-header" style="background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); color: white;">
            <i class="bi bi-pie-chart"></i>Category Breakdown
        </div>
        <div class="analytics-card-body" id="breakdown-content">
            <div class="empty-state">
                <div class="loading-spinner"></div>
                <p>Loading category breakdown...</p>
            </div>
        </div>
    </div>
    
    <!-- Recurring Transactions -->
    <div class="analytics-card" id="recurring-card">
        <div class="analytics-card-header" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white;">
            <i class="bi bi-arrow-repeat"></i>Recurring Transactions
        </div>
        <div class="analytics-card-body" id="recurring-content">
            <div class="empty-state">
                <div class="loading-spinner"></div>
                <p>Detecting recurring transactions...</p>
            </div>
        </div>
    </div>
</div>

<script>
// Scroll to card function
function scrollToCard(cardId) {
    const card = document.getElementById(cardId);
    if (card) {
        card.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // Update active chip
        document.querySelectorAll('.analytics-chip').forEach(chip => chip.classList.remove('active'));
        event.target.closest('.analytics-chip').classList.add('active');
    }
}

// Get category badge class from category name
function getCategoryClass(category) {
    const categoryMap = {
        'groceries': 'food', 'eating out': 'food', 'coffee': 'food', 'restaurants': 'food',
        'gas': 'transportation', 'uber': 'transportation', 'lyft': 'transportation', 'parking': 'transportation', 'auto': 'transportation',
        'rent': 'housing', 'mortgage': 'housing', 'utilities': 'housing', 'natural gas': 'housing', 'electric': 'housing',
        'entertainment': 'entertainment', 'subscriptions': 'entertainment', 'streaming': 'entertainment',
        'shopping': 'shopping', 'amazon': 'shopping', 'clothing': 'shopping',
        'investments': 'financial', 'credit card': 'financial', 'transfer': 'financial', 'bank': 'financial',
        'healthcare': 'health', 'pharmacy': 'health', 'medical': 'health',
        'income': 'income', 'salary': 'income', 'paycheck': 'income',
        'travel': 'travel', 'vacation': 'travel', 'hotel': 'travel', 'flight': 'travel'
    };
    
    const lower = category.toLowerCase();
    for (const [key, value] of Object.entries(categoryMap)) {
        if (lower.includes(key)) return value;
    }
    return 'other';
}

async function loadAllAnalytics() {
    await Promise.all([
        loadFinancialHealth(),
        loadAnomalies(),
        loadPredictions(),
        loadInsights(),
        loadCategoryTrends(),
        loadMerchants(),
        loadSpendingPatterns(),
        loadCategoryBreakdown(),
        loadRecurringTransactions()
    ]);
}

async function loadFinancialHealth() {
    const container = document.getElementById('health-content');
    try {
        const response = await fetch('/api/analytics/financial-health');
        const result = await response.json();
        
        if (!result.success) throw new Error(result.error);
        
        const data = result.data;
        const score = data.score || 0;
        const grade = data.grade || 'N/A';
        const factors = data.factors || {};
        const recommendations = data.recommendations || [];
        
        // Update summary stat
        document.getElementById('summary-score').textContent = score;
        
        let scoreClass = score >= 70 ? 'good' : score >= 50 ? 'fair' : 'poor';
        let scoreColor = score >= 70 ? '#10b981' : score >= 50 ? '#f59e0b' : '#ef4444';
        
        let html = `
            <div class="score-display">
                <div class="score-circle ${scoreClass}">
                    <span class="score-number" style="color: ${scoreColor}">${score}</span>
                    <span class="score-grade">${grade}</span>
                </div>
                <div class="score-status" style="color: ${scoreColor}">
                    ${score >= 70 ? 'Good' : score >= 50 ? 'Fair' : 'Needs Work'}
                </div>
            </div>
            
            <h6 class="mb-2">Score Breakdown</h6>
            ${Object.entries(factors).map(([key, f]) => {
                let factorClass = f.score >= 70 ? 'good' : f.score >= 50 ? 'fair' : 'poor';
                let barColor = f.score >= 70 ? '#10b981' : f.score >= 50 ? '#f59e0b' : '#ef4444';
                return `
                    <div class="factor-item ${factorClass}">
                        <div class="d-flex justify-content-between">
                            <span class="factor-name">${f.description}</span>
                            <span class="factor-score" style="color: ${barColor}">${f.score.toFixed(0)}/100</span>
                        </div>
                        <div class="progress-mini">
                            <div class="progress-mini-bar" style="width: ${f.score}%; background: ${barColor}"></div>
                        </div>
                    </div>
                `;
            }).join('')}
            
            ${recommendations.length > 0 ? `
                <h6 class="mt-3 mb-2">Recommendations</h6>
                ${recommendations.map(r => `<div class="recommendation-item">${r.message || r}</div>`).join('')}
            ` : ''}
        `;
        
        container.innerHTML = html;
        
    } catch (error) {
        container.innerHTML = `<div class="empty-state"><i class="bi bi-exclamation-circle"></i><p>Error: ${error.message}</p></div>`;
    }
}

async function loadAnomalies() {
    const container = document.getElementById('anomalies-content');
    try {
        const response = await fetch('/api/analytics/anomalies');
        const result = await response.json();
        
        if (!result.success) throw new Error(result.error);
        
        const data = result.data;
        const anomalies = data.anomalies || [];
        
        // Update summary stat
        document.getElementById('summary-anomalies').textContent = anomalies.length;
        
        let html = `
            <div class="stat-row">
                <div>
                    <div class="stat-value">${anomalies.length}</div>
                    <div class="stat-label">Anomalies</div>
                </div>
                <div>
                    <div class="stat-value">${data.total_analyzed || 0}</div>
                    <div class="stat-label">Analyzed</div>
                </div>
                <div>
                    <div class="stat-value">${data.anomaly_rate || 0}%</div>
                    <div class="stat-label">Rate</div>
                </div>
            </div>
        `;
        
        if (anomalies.length === 0) {
            html += `<div class="empty-state"><i class="bi bi-check-circle"></i><p>No anomalies detected!</p></div>`;
        } else {
            html += anomalies.map(a => `
                <div class="anomaly-item ${a.severity}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="anomaly-title">${a.message}</div>
                        <span class="anomaly-badge ${a.severity}">${a.severity}</span>
                    </div>
                    <div class="anomaly-details">
                        ${a.date} ‚Ä¢ ${a.category} ‚Ä¢ $${a.amount.toFixed(2)}
                    </div>
                </div>
            `).join('');
        }
        
        container.innerHTML = html;
        
    } catch (error) {
        container.innerHTML = `<div class="empty-state"><i class="bi bi-exclamation-circle"></i><p>Error: ${error.message}</p></div>`;
    }
}

async function loadPredictions() {
    const container = document.getElementById('predictions-content');
    try {
        const response = await fetch('/api/analytics/predictions');
        const result = await response.json();
        
        if (!result.success) throw new Error(result.error);
        
        const data = result.data;
        const predictions = data.predictions || [];
        
        let html = `
            <div class="stat-row">
                <div>
                    <div class="stat-value">$${(data.avg_recurring || data.average_monthly_spending || 0).toFixed(0)}</div>
                    <div class="stat-label">Avg Recurring</div>
                </div>
                <div>
                    <div class="stat-value">$${(data.median_recurring || 0).toFixed(0)}</div>
                    <div class="stat-label">Median</div>
                </div>
                <div>
                    <div class="stat-value">${data.trend_direction === 'up' ? 'üìà' : 'üìâ'}</div>
                    <div class="stat-label">Trend</div>
                </div>
            </div>
        `;
        
        if (predictions.length === 0) {
            html += `<div class="empty-state"><i class="bi bi-graph-down"></i><p>Need more data for predictions</p></div>`;
        } else {
            html += predictions.map(p => `
                <div class="prediction-item">
                    <div>
                        <div class="prediction-month">${p.month}</div>
                        <div class="prediction-range">
                            $${(p.confidence_interval?.lower || 0).toFixed(0)} - $${(p.confidence_interval?.upper || 0).toFixed(0)}
                        </div>
                    </div>
                    <div class="prediction-amount">$${(p.predicted_recurring || p.predicted_amount || 0).toFixed(0)}</div>
                </div>
            `).join('');
        }
        
        container.innerHTML = html;
        
    } catch (error) {
        container.innerHTML = `<div class="empty-state"><i class="bi bi-exclamation-circle"></i><p>Error: ${error.message}</p></div>`;
    }
}

async function loadInsights() {
    const container = document.getElementById('insights-content');
    try {
        const response = await fetch('/api/analytics/insights');
        const result = await response.json();
        
        if (!result.success) throw new Error(result.error);
        
        const data = result.data;
        const insights = data.insights || [];
        
        if (insights.length === 0) {
            container.innerHTML = `<div class="empty-state"><i class="bi bi-search"></i><p>No insights yet. Keep tracking!</p></div>`;
            return;
        }
        
        container.innerHTML = insights.map(i => `
            <div class="insight-item">
                <div class="insight-title">${i.title}</div>
                <div class="insight-description">${i.description}</div>
                <div class="insight-recommendation">üí° ${i.recommendation}</div>
            </div>
        `).join('');
        
    } catch (error) {
        container.innerHTML = `<div class="empty-state"><i class="bi bi-exclamation-circle"></i><p>Error: ${error.message}</p></div>`;
    }
}

async function loadCategoryTrends() {
    const container = document.getElementById('trends-content');
    try {
        const response = await fetch('/api/analytics/category-trends?months=3');
        const result = await response.json();
        
        if (!result.success) throw new Error(result.error);
        
        const data = result.data;
        const trends = data.trends || [];
        const insights = data.insights || [];
        const summary = data.summary || {};
        
        if (trends.length === 0) {
            container.innerHTML = `<div class="empty-state"><i class="bi bi-bar-chart"></i><p>Need more data for trend analysis</p></div>`;
            return;
        }
        
        // Update summary stats
        document.getElementById('summary-increasing').textContent = summary.increasing || 0;
        document.getElementById('summary-decreasing').textContent = summary.decreasing || 0;
        
        let html = `
            <div class="stat-row">
                <div>
                    <div class="stat-value" style="color: #ef4444;">${summary.increasing || 0}</div>
                    <div class="stat-label">üìà Increasing</div>
                </div>
                <div>
                    <div class="stat-value" style="color: #10b981;">${summary.decreasing || 0}</div>
                    <div class="stat-label">üìâ Decreasing</div>
                </div>
                <div>
                    <div class="stat-value" style="color: #6b7280;">${summary.stable || 0}</div>
                    <div class="stat-label">‚û°Ô∏è Stable</div>
                </div>
            </div>
        `;
        
        // Add insights
        if (insights.length > 0) {
            html += `<div class="mb-3">`;
            insights.forEach(i => {
                html += `<div class="recommendation-item"><i class="bi bi-lightbulb me-2"></i>${i.message}</div>`;
            });
            html += `</div>`;
        }
        
        // Add trend table (desktop)
        html += `
            <div class="trends-table-container" style="max-height: 400px; overflow-y: auto;">
                <table class="trends-table">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th style="text-align: right;">Previous</th>
                            <th style="text-align: right;">Current</th>
                            <th style="text-align: right;">Change</th>
                            <th style="text-align: center;">Trend</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        trends.forEach(t => {
            const changeColor = t.change_pct > 10 ? '#ef4444' : t.change_pct < -10 ? '#10b981' : '#6b7280';
            const changeSign = t.change_pct > 0 ? '+' : '';
            const catClass = getCategoryClass(t.category);
            html += `
                <tr>
                    <td><span class="trend-category-badge ${catClass}">${t.category}</span></td>
                    <td style="text-align: right;">$${t.previous_month.toFixed(0)}</td>
                    <td style="text-align: right;">$${t.current_month.toFixed(0)}</td>
                    <td style="text-align: right; color: ${changeColor}; font-weight: 600;">
                        ${changeSign}${t.change_pct.toFixed(0)}%
                    </td>
                    <td style="text-align: center; font-size: 1.2rem;">${t.trend_icon}</td>
                </tr>
            `;
        });
        
        html += `</tbody></table></div>`;
        
        // Add mobile cards
        trends.forEach(t => {
            const changeColor = t.change_pct > 10 ? '#ef4444' : t.change_pct < -10 ? '#10b981' : '#6b7280';
            const changeSign = t.change_pct > 0 ? '+' : '';
            const catClass = getCategoryClass(t.category);
            html += `
                <div class="trend-mobile-card">
                    <div class="trend-mobile-header">
                        <span class="trend-category-badge ${catClass}">${t.category}</span>
                        <span class="trend-mobile-change" style="color: ${changeColor}">
                            ${changeSign}${t.change_pct.toFixed(0)}% ${t.trend_icon}
                        </span>
                    </div>
                    <div class="trend-mobile-amounts">
                        <span>Previous: $${t.previous_month.toFixed(0)}</span>
                        <span>Current: $${t.current_month.toFixed(0)}</span>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
    } catch (error) {
        container.innerHTML = `<div class="empty-state"><i class="bi bi-exclamation-circle"></i><p>Error: ${error.message}</p></div>`;
    }
}

async function loadMerchants() {
    const container = document.getElementById('merchants-content');
    try {
        const response = await fetch('/api/analytics/merchants?months=3');
        const result = await response.json();
        
        if (!result.success) throw new Error(result.error);
        
        const data = result.data;
        const merchants = data.merchants || [];
        const insights = data.insights || [];
        const summary = data.summary || {};
        
        if (merchants.length === 0) {
            container.innerHTML = `<div class="empty-state"><i class="bi bi-shop"></i><p>No merchant data available</p></div>`;
            return;
        }
        
        let html = `
            <div class="stat-row">
                <div>
                    <div class="stat-value">${data.total_merchants || 0}</div>
                    <div class="stat-label">Merchants</div>
                </div>
                <div>
                    <div class="stat-value">${summary.total_transactions || 0}</div>
                    <div class="stat-label">Transactions</div>
                </div>
                <div>
                    <div class="stat-value">${summary.top_5_concentration || 0}%</div>
                    <div class="stat-label">Top 5 Share</div>
                </div>
            </div>
        `;
        
        // Add insights
        if (insights.length > 0) {
            html += `<div class="mb-3">`;
            insights.forEach(i => {
                html += `<div class="recommendation-item"><i class="bi bi-lightbulb me-2"></i>${i.message}</div>`;
            });
            html += `</div>`;
        }
        
        // Add merchant list
        html += `<div class="merchant-list" style="max-height: 350px; overflow-y: auto;">`;
        merchants.slice(0, 10).forEach((m, idx) => {
            const catClass = getCategoryClass(m.primary_category);
            html += `
                <div class="merchant-item" style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-bottom: 1px solid var(--border-color);">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <span class="merchant-rank" style="width: 24px; height: 24px; border-radius: 50%; background: ${idx < 3 ? 'linear-gradient(135deg, #f97316, #ea580c)' : 'rgba(255,255,255,0.1)'}; color: ${idx < 3 ? 'white' : 'var(--text-muted)'}; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600;">${idx + 1}</span>
                        <div>
                            <div style="font-weight: 600;">${m.name}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">
                                ${m.count} transactions ‚Ä¢ $${m.avg_transaction.toFixed(0)} avg
                            </div>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: 700; color: var(--text-primary);">$${m.total.toFixed(0)}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">${m.pct_of_spending}%</div>
                    </div>
                </div>
            `;
        });
        html += `</div>`;
        
        container.innerHTML = html;
        
    } catch (error) {
        container.innerHTML = `<div class="empty-state"><i class="bi bi-exclamation-circle"></i><p>Error: ${error.message}</p></div>`;
    }
}

async function loadSpendingPatterns() {
    const container = document.getElementById('patterns-content');
    try {
        const response = await fetch('/api/analytics/spending-patterns?months=3');
        const result = await response.json();
        
        if (!result.success) throw new Error(result.error);
        
        const data = result.data;
        const dayOfWeek = data.day_of_week || [];
        const insights = data.insights || [];
        const summary = data.summary || {};
        
        if (dayOfWeek.length === 0) {
            container.innerHTML = `<div class="empty-state"><i class="bi bi-calendar-week"></i><p>No pattern data available</p></div>`;
            return;
        }
        
        let html = `
            <div class="stat-row">
                <div>
                    <div class="stat-value">$${(summary.avg_daily_spending || 0).toFixed(0)}</div>
                    <div class="stat-label">Avg/Day</div>
                </div>
                <div>
                    <div class="stat-value">${summary.weekend_pct || 0}%</div>
                    <div class="stat-label">Weekend</div>
                </div>
                <div>
                    <div class="stat-value">${data.total_transactions || 0}</div>
                    <div class="stat-label">Transactions</div>
                </div>
            </div>
        `;
        
        // Add insights
        if (insights.length > 0) {
            html += `<div class="mb-3">`;
            insights.forEach(i => {
                html += `<div class="recommendation-item"><i class="bi bi-lightbulb me-2"></i>${i.message}</div>`;
            });
            html += `</div>`;
        }
        
        // Day of week bar chart
        const maxDow = Math.max(...dayOfWeek.map(d => d.total));
        html += `
            <h6 class="mb-2" style="font-size: 0.85rem; color: var(--text-muted);">Spending by Day of Week</h6>
            <div class="dow-chart" style="display: flex; flex-direction: column; gap: 0.5rem;">
        `;
        
        dayOfWeek.forEach(d => {
            const barWidth = maxDow > 0 ? (d.total / maxDow * 100) : 0;
            const isWeekend = d.day_index >= 5;
            const barColor = isWeekend ? '#f97316' : '#0ea5e9';
            html += `
                <div class="dow-row" style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="width: 30px; font-size: 0.75rem; color: var(--text-muted);">${d.day.slice(0, 3)}</span>
                    <div style="flex: 1; height: 24px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden; position: relative;">
                        <div style="width: ${barWidth}%; height: 100%; background: ${barColor}; border-radius: 4px; transition: width 0.3s;"></div>
                        <span style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 0.75rem; font-weight: 600;">$${d.total.toFixed(0)}</span>
                    </div>
                    <span style="width: 40px; text-align: right; font-size: 0.75rem; color: var(--text-muted);">${d.pct_of_total}%</span>
                </div>
            `;
        });
        
        html += `</div>`;
        
        // Day of month heatmap (simplified)
        const domData = data.day_of_month || [];
        if (domData.length > 0) {
            html += `
                <h6 class="mt-3 mb-2" style="font-size: 0.85rem; color: var(--text-muted);">Day of Month Heatmap</h6>
                <div class="dom-heatmap" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px;">
            `;
            
            domData.forEach(d => {
                const intensity = d.intensity || 0;
                const bgColor = intensity > 0.7 ? '#ef4444' : intensity > 0.4 ? '#f97316' : intensity > 0.1 ? '#0ea5e9' : 'rgba(255,255,255,0.05)';
                const textColor = intensity > 0.4 ? 'white' : 'var(--text-muted)';
                html += `
                    <div style="aspect-ratio: 1; display: flex; align-items: center; justify-content: center; background: ${bgColor}; border-radius: 4px; font-size: 0.65rem; color: ${textColor}; cursor: default;" title="Day ${d.day}: $${d.total.toFixed(0)} (${d.count} txns)">
                        ${d.day}
                    </div>
                `;
            });
            
            html += `</div>`;
            html += `<div style="display: flex; justify-content: center; gap: 1rem; margin-top: 0.5rem; font-size: 0.7rem; color: var(--text-muted);">
                <span><span style="display: inline-block; width: 12px; height: 12px; background: rgba(255,255,255,0.05); border-radius: 2px; vertical-align: middle;"></span> Low</span>
                <span><span style="display: inline-block; width: 12px; height: 12px; background: #0ea5e9; border-radius: 2px; vertical-align: middle;"></span> Medium</span>
                <span><span style="display: inline-block; width: 12px; height: 12px; background: #f97316; border-radius: 2px; vertical-align: middle;"></span> High</span>
                <span><span style="display: inline-block; width: 12px; height: 12px; background: #ef4444; border-radius: 2px; vertical-align: middle;"></span> Peak</span>
            </div>`;
        }
        
        container.innerHTML = html;
        
    } catch (error) {
        container.innerHTML = `<div class="empty-state"><i class="bi bi-exclamation-circle"></i><p>Error: ${error.message}</p></div>`;
    }
}

async function loadCategoryBreakdown() {
    const container = document.getElementById('breakdown-content');
    try {
        const response = await fetch('/api/analytics/category-breakdown');
        const result = await response.json();
        
        if (!result.success) throw new Error(result.error);
        
        const data = result.data;
        const categories = data.categories || [];
        const groups = data.groups || [];
        
        if (categories.length === 0) {
            container.innerHTML = `<div class="empty-state"><i class="bi bi-pie-chart"></i><p>No spending data available</p></div>`;
            return;
        }
        
        let html = `
            <div class="text-center mb-3">
                <div style="font-size: 0.85rem; color: var(--text-muted);">${data.month_name}</div>
                <div style="font-size: 1.5rem; font-weight: 700;">$${data.total_spending.toLocaleString()}</div>
                <div style="font-size: 0.75rem; color: var(--text-muted);">${data.total_categories} categories</div>
            </div>
        `;
        
        // Donut chart using CSS
        html += `<div class="donut-chart-container" style="position: relative; width: 180px; height: 180px; margin: 0 auto 1rem;">`;
        
        // Create donut segments
        let cumulativePct = 0;
        const segments = groups.slice(0, 6); // Top 6 groups
        
        html += `<svg viewBox="0 0 36 36" style="width: 100%; height: 100%; transform: rotate(-90deg);">`;
        segments.forEach((g, idx) => {
            const dashArray = `${g.pct} ${100 - g.pct}`;
            const dashOffset = -cumulativePct;
            html += `<circle cx="18" cy="18" r="15.9" fill="none" stroke="${g.color}" stroke-width="3.5" 
                stroke-dasharray="${dashArray}" stroke-dashoffset="${dashOffset}" 
                style="cursor: pointer;" data-group="${g.name}" data-amount="${g.total}" data-pct="${g.pct}"/>`;
            cumulativePct += g.pct;
        });
        html += `</svg>`;
        
        // Center text
        html += `<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
            <div style="font-size: 0.7rem; color: var(--text-muted);">Top Category</div>
            <div style="font-size: 0.85rem; font-weight: 600;">${groups[0]?.name || 'N/A'}</div>
            <div style="font-size: 0.75rem; color: ${groups[0]?.color || '#666'};">${groups[0]?.pct || 0}%</div>
        </div>`;
        html += `</div>`;
        
        // Legend
        html += `<div class="breakdown-legend" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">`;
        groups.slice(0, 6).forEach(g => {
            html += `
                <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem;">
                    <span style="width: 12px; height: 12px; border-radius: 3px; background: ${g.color}; flex-shrink: 0;"></span>
                    <span style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${g.name}</span>
                    <span style="font-weight: 600;">${g.pct}%</span>
                </div>
            `;
        });
        html += `</div>`;
        
        // Top categories list
        html += `<h6 style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.5rem;">Top Categories</h6>`;
        html += `<div style="max-height: 200px; overflow-y: auto;">`;
        categories.slice(0, 8).forEach((c, idx) => {
            html += `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="width: 8px; height: 8px; border-radius: 50%; background: ${c.color};"></span>
                        <span style="font-size: 0.85rem;">${c.name}</span>
                    </div>
                    <div style="text-align: right;">
                        <span style="font-weight: 600;">$${c.total.toFixed(0)}</span>
                        <span style="font-size: 0.75rem; color: var(--text-muted); margin-left: 0.5rem;">${c.pct}%</span>
                    </div>
                </div>
            `;
        });
        html += `</div>`;
        
        container.innerHTML = html;
        
    } catch (error) {
        container.innerHTML = `<div class="empty-state"><i class="bi bi-exclamation-circle"></i><p>Error: ${error.message}</p></div>`;
    }
}

async function loadRecurringTransactions() {
    const container = document.getElementById('recurring-content');
    try {
        const response = await fetch('/api/analytics/recurring?months=6');
        const result = await response.json();
        
        if (!result.success) throw new Error(result.error);
        
        const data = result.data;
        const recurring = data.recurring || [];
        const insights = data.insights || [];
        const summary = data.summary || {};
        
        if (recurring.length === 0) {
            container.innerHTML = `<div class="empty-state"><i class="bi bi-arrow-repeat"></i><p>No recurring transactions detected yet.<br><small>Need more transaction history.</small></p></div>`;
            return;
        }
        
        let html = `
            <div class="stat-row">
                <div>
                    <div class="stat-value">${summary.subscriptions || 0}</div>
                    <div class="stat-label">Subscriptions</div>
                </div>
                <div>
                    <div class="stat-value">${summary.monthly_bills || 0}</div>
                    <div class="stat-label">Bills</div>
                </div>
                <div>
                    <div class="stat-value">$${(summary.estimated_monthly_recurring || 0).toFixed(0)}</div>
                    <div class="stat-label">Monthly</div>
                </div>
            </div>
        `;
        
        // Add insights
        if (insights.length > 0) {
            html += `<div class="mb-3">`;
            insights.forEach(i => {
                html += `<div class="recommendation-item"><i class="bi bi-lightbulb me-2"></i>${i.message}</div>`;
            });
            html += `</div>`;
        }
        
        // Recurring items list
        html += `<div class="recurring-list" style="max-height: 350px; overflow-y: auto;">`;
        recurring.forEach(r => {
            const freqBadgeColor = {
                'weekly': '#3b82f6',
                'bi-weekly': '#8b5cf6',
                'monthly': '#22c55e',
                'quarterly': '#f59e0b',
                'annual': '#ef4444'
            }[r.frequency] || '#64748b';
            
            const isUpcoming = new Date(r.next_expected) <= new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);
            
            html += `
                <div class="recurring-item" style="padding: 0.75rem; border-bottom: 1px solid var(--border-color); ${isUpcoming ? 'background: rgba(34, 197, 94, 0.1);' : ''}">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.25rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            ${r.is_subscription ? '<i class="bi bi-phone" style="color: #a855f7;"></i>' : '<i class="bi bi-receipt" style="color: #22c55e;"></i>'}
                            <span style="font-weight: 600;">${r.merchant}</span>
                        </div>
                        <span style="font-weight: 700;">$${r.avg_amount.toFixed(2)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: var(--text-muted);">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="background: ${freqBadgeColor}; color: white; padding: 0.1rem 0.4rem; border-radius: 4px; font-size: 0.65rem; text-transform: uppercase;">${r.frequency}</span>
                            <span>${r.occurrences}x</span>
                            <span style="opacity: 0.7;">${r.confidence}% conf</span>
                        </div>
                        <div>
                            ${isUpcoming ? '<span style="color: #22c55e;"><i class="bi bi-clock"></i> Soon</span>' : `Next: ${r.next_expected.slice(5)}`}
                        </div>
                    </div>
                </div>
            `;
        });
        html += `</div>`;
        
        container.innerHTML = html;
        
    } catch (error) {
        container.innerHTML = `<div class="empty-state"><i class="bi bi-exclamation-circle"></i><p>Error: ${error.message}</p></div>`;
    }
}

// Load analytics on page load
document.addEventListener('DOMContentLoaded', loadAllAnalytics);
</script>
{% endblock %}
