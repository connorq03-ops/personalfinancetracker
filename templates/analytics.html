{% extends "base.html" %}

{% block title %}Advanced Analytics | Personal Finance Tracker{% endblock %}

{% block head %}
<style>
    .analytics-header {
        background: linear-gradient(135deg, var(--primary) 0%, #8b5cf6 100%);
        color: white;
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
    }
    
    .analytics-title {
        font-size: 1.75rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .analytics-subtitle {
        opacity: 0.9;
        font-size: 1rem;
    }
    
    .analytics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
        gap: 1.5rem;
    }
    
    .analytics-card {
        background: var(--card-bg);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .analytics-card-header {
        padding: 1rem 1.25rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .analytics-card-header.health { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
    .analytics-card-header.anomalies { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; }
    .analytics-card-header.predictions { background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); color: white; }
    .analytics-card-header.insights { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; }
    
    .analytics-card-body {
        padding: 1.25rem;
    }
    
    .score-display {
        text-align: center;
        padding: 1rem 0;
    }
    
    .score-circle {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        background: rgba(16, 185, 129, 0.1);
        border: 4px solid #10b981;
    }
    
    .score-circle.good { border-color: #10b981; }
    .score-circle.fair { border-color: #f59e0b; }
    .score-circle.poor { border-color: #ef4444; }
    
    .score-number {
        font-size: 2rem;
        font-weight: 700;
        line-height: 1;
    }
    
    .score-grade {
        font-size: 1.1rem;
        font-weight: 600;
        opacity: 0.8;
    }
    
    .score-status {
        font-size: 1rem;
        font-weight: 600;
    }
    
    .factor-item {
        background: rgba(255,255,255,0.5);
        padding: 0.75rem;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        border-left: 3px solid #e5e7eb;
    }
    
    .factor-item.good { border-left-color: #10b981; }
    .factor-item.fair { border-left-color: #f59e0b; }
    .factor-item.poor { border-left-color: #ef4444; }
    
    .factor-name {
        font-size: 0.85rem;
        color: var(--text-secondary);
    }
    
    .factor-score {
        font-weight: 600;
        font-size: 0.9rem;
    }
    
    .progress-mini {
        height: 4px;
        border-radius: 2px;
        background: rgba(0,0,0,0.1);
        margin-top: 0.25rem;
    }
    
    .progress-mini-bar {
        height: 100%;
        border-radius: 2px;
        transition: width 0.3s ease;
    }
    
    .recommendation-item {
        background: rgba(99, 102, 241, 0.1);
        padding: 0.75rem;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        border-left: 3px solid var(--primary);
    }
    
    .anomaly-item {
        padding: 0.75rem;
        border-radius: 8px;
        margin-bottom: 0.75rem;
        border-left: 4px solid;
    }
    
    .anomaly-item.high {
        background: rgba(239, 68, 68, 0.1);
        border-left-color: #ef4444;
    }
    
    .anomaly-item.medium {
        background: rgba(245, 158, 11, 0.1);
        border-left-color: #f59e0b;
    }
    
    .anomaly-title {
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
    }
    
    .anomaly-details {
        font-size: 0.8rem;
        color: var(--text-secondary);
    }
    
    .anomaly-badge {
        display: inline-block;
        padding: 0.15rem 0.5rem;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .anomaly-badge.high { background: #ef4444; color: white; }
    .anomaly-badge.medium { background: #f59e0b; color: white; }
    
    .prediction-item {
        background: rgba(6, 182, 212, 0.05);
        padding: 0.75rem;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .prediction-month {
        font-weight: 600;
    }
    
    .prediction-amount {
        font-size: 1.1rem;
        font-weight: 700;
        color: #06b6d4;
    }
    
    .prediction-range {
        font-size: 0.75rem;
        color: var(--text-secondary);
    }
    
    .insight-item {
        padding: 0.75rem;
        border-radius: 8px;
        margin-bottom: 0.75rem;
        background: rgba(139, 92, 246, 0.05);
        border-left: 3px solid #8b5cf6;
    }
    
    .insight-title {
        font-weight: 600;
        margin-bottom: 0.25rem;
    }
    
    .insight-description {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-bottom: 0.5rem;
    }
    
    .insight-recommendation {
        font-size: 0.8rem;
        padding: 0.5rem;
        background: rgba(139, 92, 246, 0.1);
        border-radius: 4px;
    }
    
    .stat-row {
        display: flex;
        justify-content: space-around;
        text-align: center;
        padding: 1rem 0;
        border-bottom: 1px solid rgba(0,0,0,0.05);
        margin-bottom: 1rem;
    }
    
    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
    }
    
    .stat-label {
        font-size: 0.75rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .empty-state {
        text-align: center;
        padding: 2rem;
        color: var(--text-secondary);
    }
    
    .empty-state i {
        font-size: 2.5rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    .loading-spinner {
        display: inline-block;
        width: 1.5rem;
        height: 1.5rem;
        border: 2px solid rgba(255,255,255,0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .refresh-btn {
        background: rgba(255,255,255,0.2);
        border: 1px solid rgba(255,255,255,0.3);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .refresh-btn:hover {
        background: rgba(255,255,255,0.3);
    }
    
    @media (max-width: 768px) {
        .analytics-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="analytics-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="analytics-title">
                <i class="bi bi-graph-up-arrow me-2"></i>Advanced Analytics
            </h1>
            <p class="analytics-subtitle">AI-powered insights, predictions, and financial health analysis</p>
        </div>
        <button class="refresh-btn" onclick="loadAllAnalytics()">
            <i class="bi bi-arrow-clockwise me-1"></i>Refresh
        </button>
    </div>
</div>

<!-- Analytics Grid -->
<div class="analytics-grid">
    <!-- Financial Health Score -->
    <div class="analytics-card" id="health-card">
        <div class="analytics-card-header health">
            <i class="bi bi-heart-pulse"></i>Financial Health Score
        </div>
        <div class="analytics-card-body" id="health-content">
            <div class="empty-state">
                <div class="loading-spinner"></div>
                <p>Calculating your financial health...</p>
            </div>
        </div>
    </div>
    
    <!-- Spending Anomalies -->
    <div class="analytics-card" id="anomalies-card">
        <div class="analytics-card-header anomalies">
            <i class="bi bi-exclamation-triangle"></i>Spending Anomalies
        </div>
        <div class="analytics-card-body" id="anomalies-content">
            <div class="empty-state">
                <div class="loading-spinner"></div>
                <p>Detecting unusual patterns...</p>
            </div>
        </div>
    </div>
    
    <!-- Spending Predictions -->
    <div class="analytics-card" id="predictions-card">
        <div class="analytics-card-header predictions">
            <i class="bi bi-graph-up"></i>Spending Predictions
        </div>
        <div class="analytics-card-body" id="predictions-content">
            <div class="empty-state">
                <div class="loading-spinner"></div>
                <p>Generating predictions...</p>
            </div>
        </div>
    </div>
    
    <!-- Spending Insights -->
    <div class="analytics-card" id="insights-card">
        <div class="analytics-card-header insights">
            <i class="bi bi-lightbulb"></i>Spending Insights
        </div>
        <div class="analytics-card-body" id="insights-content">
            <div class="empty-state">
                <div class="loading-spinner"></div>
                <p>Analyzing spending patterns...</p>
            </div>
        </div>
    </div>
    
    <!-- Category Trends -->
    <div class="analytics-card" id="trends-card" style="grid-column: 1 / -1;">
        <div class="analytics-card-header" style="background: linear-gradient(135deg, #ec4899 0%, #be185d 100%); color: white;">
            <i class="bi bi-bar-chart-line"></i>Category Trends
        </div>
        <div class="analytics-card-body" id="trends-content">
            <div class="empty-state">
                <div class="loading-spinner"></div>
                <p>Analyzing category trends...</p>
            </div>
        </div>
    </div>
</div>

<script>
async function loadAllAnalytics() {
    await Promise.all([
        loadFinancialHealth(),
        loadAnomalies(),
        loadPredictions(),
        loadInsights(),
        loadCategoryTrends()
    ]);
}

async function loadFinancialHealth() {
    const container = document.getElementById('health-content');
    try {
        const response = await fetch('/api/analytics/financial-health');
        const result = await response.json();
        
        if (!result.success) throw new Error(result.error);
        
        const data = result.data;
        const score = data.score || 0;
        const grade = data.grade || 'N/A';
        const factors = data.factors || {};
        const recommendations = data.recommendations || [];
        
        let scoreClass = score >= 70 ? 'good' : score >= 50 ? 'fair' : 'poor';
        let scoreColor = score >= 70 ? '#10b981' : score >= 50 ? '#f59e0b' : '#ef4444';
        
        let html = `
            <div class="score-display">
                <div class="score-circle ${scoreClass}">
                    <span class="score-number" style="color: ${scoreColor}">${score}</span>
                    <span class="score-grade">${grade}</span>
                </div>
                <div class="score-status" style="color: ${scoreColor}">
                    ${score >= 70 ? 'Good' : score >= 50 ? 'Fair' : 'Needs Work'}
                </div>
            </div>
            
            <h6 class="mb-2">Score Breakdown</h6>
            ${Object.entries(factors).map(([key, f]) => {
                let factorClass = f.score >= 70 ? 'good' : f.score >= 50 ? 'fair' : 'poor';
                let barColor = f.score >= 70 ? '#10b981' : f.score >= 50 ? '#f59e0b' : '#ef4444';
                return `
                    <div class="factor-item ${factorClass}">
                        <div class="d-flex justify-content-between">
                            <span class="factor-name">${f.description}</span>
                            <span class="factor-score" style="color: ${barColor}">${f.score.toFixed(0)}/100</span>
                        </div>
                        <div class="progress-mini">
                            <div class="progress-mini-bar" style="width: ${f.score}%; background: ${barColor}"></div>
                        </div>
                    </div>
                `;
            }).join('')}
            
            ${recommendations.length > 0 ? `
                <h6 class="mt-3 mb-2">Recommendations</h6>
                ${recommendations.map(r => `<div class="recommendation-item">${r.message || r}</div>`).join('')}
            ` : ''}
        `;
        
        container.innerHTML = html;
        
    } catch (error) {
        container.innerHTML = `<div class="empty-state"><i class="bi bi-exclamation-circle"></i><p>Error: ${error.message}</p></div>`;
    }
}

async function loadAnomalies() {
    const container = document.getElementById('anomalies-content');
    try {
        const response = await fetch('/api/analytics/anomalies');
        const result = await response.json();
        
        if (!result.success) throw new Error(result.error);
        
        const data = result.data;
        const anomalies = data.anomalies || [];
        
        let html = `
            <div class="stat-row">
                <div>
                    <div class="stat-value">${anomalies.length}</div>
                    <div class="stat-label">Anomalies</div>
                </div>
                <div>
                    <div class="stat-value">${data.total_analyzed || 0}</div>
                    <div class="stat-label">Analyzed</div>
                </div>
                <div>
                    <div class="stat-value">${data.anomaly_rate || 0}%</div>
                    <div class="stat-label">Rate</div>
                </div>
            </div>
        `;
        
        if (anomalies.length === 0) {
            html += `<div class="empty-state"><i class="bi bi-check-circle"></i><p>No anomalies detected!</p></div>`;
        } else {
            html += anomalies.map(a => `
                <div class="anomaly-item ${a.severity}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="anomaly-title">${a.message}</div>
                        <span class="anomaly-badge ${a.severity}">${a.severity}</span>
                    </div>
                    <div class="anomaly-details">
                        ${a.date} ‚Ä¢ ${a.category} ‚Ä¢ $${a.amount.toFixed(2)}
                    </div>
                </div>
            `).join('');
        }
        
        container.innerHTML = html;
        
    } catch (error) {
        container.innerHTML = `<div class="empty-state"><i class="bi bi-exclamation-circle"></i><p>Error: ${error.message}</p></div>`;
    }
}

async function loadPredictions() {
    const container = document.getElementById('predictions-content');
    try {
        const response = await fetch('/api/analytics/predictions');
        const result = await response.json();
        
        if (!result.success) throw new Error(result.error);
        
        const data = result.data;
        const predictions = data.predictions || [];
        
        let html = `
            <div class="stat-row">
                <div>
                    <div class="stat-value">$${(data.avg_recurring || data.average_monthly_spending || 0).toFixed(0)}</div>
                    <div class="stat-label">Avg Recurring</div>
                </div>
                <div>
                    <div class="stat-value">$${(data.median_recurring || 0).toFixed(0)}</div>
                    <div class="stat-label">Median</div>
                </div>
                <div>
                    <div class="stat-value">${data.trend_direction === 'up' ? 'üìà' : 'üìâ'}</div>
                    <div class="stat-label">Trend</div>
                </div>
            </div>
        `;
        
        if (predictions.length === 0) {
            html += `<div class="empty-state"><i class="bi bi-graph-down"></i><p>Need more data for predictions</p></div>`;
        } else {
            html += predictions.map(p => `
                <div class="prediction-item">
                    <div>
                        <div class="prediction-month">${p.month}</div>
                        <div class="prediction-range">
                            $${(p.confidence_interval?.lower || 0).toFixed(0)} - $${(p.confidence_interval?.upper || 0).toFixed(0)}
                        </div>
                    </div>
                    <div class="prediction-amount">$${(p.predicted_recurring || p.predicted_amount || 0).toFixed(0)}</div>
                </div>
            `).join('');
        }
        
        container.innerHTML = html;
        
    } catch (error) {
        container.innerHTML = `<div class="empty-state"><i class="bi bi-exclamation-circle"></i><p>Error: ${error.message}</p></div>`;
    }
}

async function loadInsights() {
    const container = document.getElementById('insights-content');
    try {
        const response = await fetch('/api/analytics/insights');
        const result = await response.json();
        
        if (!result.success) throw new Error(result.error);
        
        const data = result.data;
        const insights = data.insights || [];
        
        if (insights.length === 0) {
            container.innerHTML = `<div class="empty-state"><i class="bi bi-search"></i><p>No insights yet. Keep tracking!</p></div>`;
            return;
        }
        
        container.innerHTML = insights.map(i => `
            <div class="insight-item">
                <div class="insight-title">${i.title}</div>
                <div class="insight-description">${i.description}</div>
                <div class="insight-recommendation">üí° ${i.recommendation}</div>
            </div>
        `).join('');
        
    } catch (error) {
        container.innerHTML = `<div class="empty-state"><i class="bi bi-exclamation-circle"></i><p>Error: ${error.message}</p></div>`;
    }
}

async function loadCategoryTrends() {
    const container = document.getElementById('trends-content');
    try {
        const response = await fetch('/api/analytics/category-trends?months=3');
        const result = await response.json();
        
        if (!result.success) throw new Error(result.error);
        
        const data = result.data;
        const trends = data.trends || [];
        const insights = data.insights || [];
        const summary = data.summary || {};
        
        if (trends.length === 0) {
            container.innerHTML = `<div class="empty-state"><i class="bi bi-bar-chart"></i><p>Need more data for trend analysis</p></div>`;
            return;
        }
        
        let html = `
            <div class="stat-row">
                <div>
                    <div class="stat-value" style="color: #10b981;">${summary.increasing || 0}</div>
                    <div class="stat-label">üìà Increasing</div>
                </div>
                <div>
                    <div class="stat-value" style="color: #ef4444;">${summary.decreasing || 0}</div>
                    <div class="stat-label">üìâ Decreasing</div>
                </div>
                <div>
                    <div class="stat-value" style="color: #6b7280;">${summary.stable || 0}</div>
                    <div class="stat-label">‚û°Ô∏è Stable</div>
                </div>
            </div>
        `;
        
        // Add insights
        if (insights.length > 0) {
            html += `<div class="mb-3">`;
            insights.forEach(i => {
                html += `<div class="recommendation-item">${i.message}</div>`;
            });
            html += `</div>`;
        }
        
        // Add trend table
        html += `
            <div style="max-height: 400px; overflow-y: auto;">
                <table style="width: 100%; font-size: 0.9rem;">
                    <thead style="position: sticky; top: 0; background: var(--card-bg);">
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <th style="text-align: left; padding: 0.5rem;">Category</th>
                            <th style="text-align: right; padding: 0.5rem;">Previous</th>
                            <th style="text-align: right; padding: 0.5rem;">Current</th>
                            <th style="text-align: right; padding: 0.5rem;">Change</th>
                            <th style="text-align: center; padding: 0.5rem;">Trend</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        trends.forEach(t => {
            const changeColor = t.change_pct > 10 ? '#ef4444' : t.change_pct < -10 ? '#10b981' : '#6b7280';
            const changeSign = t.change_pct > 0 ? '+' : '';
            html += `
                <tr style="border-bottom: 1px solid var(--border-color);">
                    <td style="padding: 0.5rem; font-weight: 500;">${t.category}</td>
                    <td style="text-align: right; padding: 0.5rem;">$${t.previous_month.toFixed(0)}</td>
                    <td style="text-align: right; padding: 0.5rem;">$${t.current_month.toFixed(0)}</td>
                    <td style="text-align: right; padding: 0.5rem; color: ${changeColor}; font-weight: 600;">
                        ${changeSign}${t.change_pct.toFixed(0)}%
                    </td>
                    <td style="text-align: center; padding: 0.5rem;">${t.trend_icon}</td>
                </tr>
            `;
        });
        
        html += `</tbody></table></div>`;
        
        container.innerHTML = html;
        
    } catch (error) {
        container.innerHTML = `<div class="empty-state"><i class="bi bi-exclamation-circle"></i><p>Error: ${error.message}</p></div>`;
    }
}

// Load analytics on page load
document.addEventListener('DOMContentLoaded', loadAllAnalytics);
</script>
{% endblock %}
