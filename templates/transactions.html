{% extends "base.html" %}

{% block title %}Transactions | Personal Finance Tracker{% endblock %}

{% block content %}
<!-- Month Navigation -->
<div class="month-nav mb-4">
    <a href="?all=1" class="btn btn-outline-light {% if show_all %}active{% endif %}">
        All Time
    </a>
    {% for m in available_months %}
    <a href="?year={{ m.year }}&month={{ m.month }}" 
       class="btn btn-outline-light {% if not show_all and m.year == year and m.month == month %}active{% endif %}">
        {{ m.label }}
    </a>
    {% endfor %}
</div>

<!-- Summary Stats -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <div class="stat-label"><i class="bi bi-arrow-down-circle me-1"></i>Income</div>
                <div class="stat-value text-success">${{ "%.2f"|format(summary.income) }}</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <div class="stat-label"><i class="bi bi-arrow-up-circle me-1"></i>Expenses</div>
                <div class="stat-value text-danger">${{ "%.2f"|format(summary.expenses) }}</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <div class="stat-label"><i class="bi bi-wallet2 me-1"></i>Net Cashflow</div>
                <div class="stat-value {% if summary.net >= 0 %}text-success{% else %}text-danger{% endif %}">
                    ${{ "%.2f"|format(summary.net) }}
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <div class="stat-label"><i class="bi bi-receipt me-1"></i>Transactions</div>
                <div class="stat-value">{{ summary.count }}</div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Filter Chips -->
<div class="filter-chips">
    <a href="{% if show_all %}?all=1{% else %}?year={{ year }}&month={{ month }}{% endif %}" 
       class="filter-chip {% if not txn_type and not category_id %}active{% endif %}">
        <i class="bi bi-grid"></i> All
    </a>
    <a href="{% if show_all %}?all=1{% else %}?year={{ year }}&month={{ month }}{% endif %}&type=expense" 
       class="filter-chip {% if txn_type == 'expense' %}active{% endif %}">
        <i class="bi bi-arrow-up-circle"></i> Expenses
    </a>
    <a href="{% if show_all %}?all=1{% else %}?year={{ year }}&month={{ month }}{% endif %}&type=income" 
       class="filter-chip {% if txn_type == 'income' %}active{% endif %}">
        <i class="bi bi-arrow-down-circle"></i> Income
    </a>
    <span class="filter-chip" onclick="document.getElementById('filterPanel').classList.toggle('d-none')">
        <i class="bi bi-funnel"></i> More Filters
    </span>
</div>

<!-- Collapsible Filters -->
<div class="card mb-4 d-none" id="filterPanel">
    <div class="card-body">
        <form method="GET" class="row g-3">
            {% if show_all %}
            <input type="hidden" name="all" value="1">
            {% else %}
            <input type="hidden" name="year" value="{{ year }}">
            <input type="hidden" name="month" value="{{ month }}">
            {% endif %}
            
            <div class="col-md-3">
                <label class="form-label">Category</label>
                <select name="category" class="form-select">
                    <option value="">All Categories</option>
                    {% for cat in categories %}
                    <option value="{{ cat.id }}" {% if cat.id == category_id %}selected{% endif %}>
                        {{ cat.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-2">
                <label class="form-label">Type</label>
                <select name="type" class="form-select">
                    <option value="">All</option>
                    <option value="income" {% if txn_type == 'income' %}selected{% endif %}>Income</option>
                    <option value="expense" {% if txn_type == 'expense' %}selected{% endif %}>Expenses</option>
                </select>
            </div>
            
            <div class="col-md-4">
                <label class="form-label">Search</label>
                <input type="text" name="search" class="form-control" 
                       placeholder="Search descriptions..." value="{{ search }}">
            </div>
            
            <div class="col-md-3 d-flex align-items-end">
                <button type="submit" class="btn btn-primary me-2">
                    <i class="bi bi-search me-1"></i>Filter
                </button>
                <a href="{% if show_all %}?all=1{% else %}?year={{ year }}&month={{ month }}{% endif %}" class="btn btn-outline-light">
                    Clear
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Transactions Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="bi bi-list-ul me-2"></i>{{ month_name }} {% if not show_all %}{{ year }}{% endif %}
        </h5>
        <div>
            <button class="btn btn-sm btn-outline-warning me-2" onclick="bulkRecategorize()" title="Apply ML to uncategorized">
                <i class="bi bi-magic me-1"></i>Auto-Categorize
            </button>
            <span class="badge bg-primary">{{ transactions|length }} transactions</span>
        </div>
    </div>
    
    <!-- Bulk Selection Bar -->
    <div class="bulk-select-bar" id="bulkSelectBar">
        <span class="selected-count"><span id="selectedCount">0</span> selected</span>
        <div class="bulk-actions">
            <button class="btn" onclick="openBulkCategoryModal()">
                <i class="bi bi-tag me-1"></i>Categorize
            </button>
            <button class="btn" onclick="bulkDelete()">
                <i class="bi bi-trash me-1"></i>Delete
            </button>
            <button class="btn" onclick="clearSelection()">
                <i class="bi bi-x-lg me-1"></i>Cancel
            </button>
        </div>
    </div>
    
    <div class="card-body p-0">
        <!-- Desktop Table View -->
        <div class="table-responsive desktop-table" style="max-height: calc(100vh - 400px); min-height: 400px; overflow-y: auto;">
            <table class="table table-hover mb-0">
                <thead class="sticky-top" style="background: rgba(30, 27, 75, 0.98); z-index: 10;">
                    <tr>
                        <th style="width: 40px;">
                            <input type="checkbox" class="row-checkbox" id="selectAll" onchange="toggleSelectAll(this.checked)">
                        </th>
                        <th>Date</th>
                        <th>Merchant</th>
                        <th>Description</th>
                        <th>Category</th>
                        <th class="text-end">Amount</th>
                        <th class="text-center" title="Mark as recurring expense for budget planning">
                            <i class="bi bi-calendar-check"></i>
                        </th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% set current_date = namespace(value=None) %}
                    {% for t in transactions %}
                    {% set txn_date = t.date.strftime('%Y-%m-%d') %}
                    {% if txn_date != current_date.value %}
                    {% set current_date.value = txn_date %}
                    <tr class="date-group-header">
                        <td colspan="8">
                            <i class="bi bi-calendar3"></i>
                            {{ t.date.strftime('%A, %B %d, %Y') }}
                        </td>
                    </tr>
                    {% endif %}
                    <tr data-id="{{ t.id }}">
                        <td>
                            <input type="checkbox" class="row-checkbox" data-id="{{ t.id }}" onchange="updateSelection()">
                        </td>
                        <td class="text-nowrap">
                            {{ t.date.strftime('%b %d') }}
                            {% if t.source == 'Robinhood CC' %}
                            <span class="badge source-badge rh" title="Robinhood CC">RH</span>
                            {% elif t.source == 'Bank of America' %}
                            <span class="badge source-badge boa" title="Bank of America">BoA</span>
                            {% elif t.source == 'Venmo' %}
                            <span class="badge source-badge venmo" title="Venmo">V</span>
                            {% endif %}
                        </td>
                        <td class="fw-medium">{{ t.description|merchant }}</td>
                        <td>
                            <small class="text-muted text-truncate d-inline-block" style="max-width: 250px;">
                                {{ t.description }}
                            </small>
                        </td>
                        <td>
                            {% set group_class = 'group-' + (t.category.group|lower|replace(' ', '-') if t.category else 'other') %}
                            <span class="badge category-badge {{ group_class }}" 
                                  data-transaction-id="{{ t.id }}"
                                  onclick="openCategoryModal({{ t.id }}, '{{ t.category.name if t.category else 'Uncategorized' }}')"
                                  style="cursor: pointer;">
                                {{ t.category.name if t.category else 'Uncategorized' }}
                            </span>
                        </td>
                        <td class="text-end text-nowrap">
                            <span class="{% if t.amount >= 0 %}text-success{% else %}text-danger{% endif %} fw-bold">
                                {% if t.amount >= 0 %}+{% endif %}${{ "%.2f"|format(t.amount|abs) }}
                            </span>
                        </td>
                        <td class="text-center">
                            <div class="form-check d-flex justify-content-center m-0">
                                <input class="form-check-input" type="checkbox" 
                                       id="recurring-{{ t.id }}"
                                       {% if t.is_recurring %}checked{% endif %}
                                       onchange="toggleRecurring({{ t.id }}, this.checked)"
                                       title="Mark as recurring">
                            </div>
                        </td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteTransaction({{ t.id }})" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="8" class="text-center py-5">
                            <div class="empty-state">
                                <div class="empty-state-icon"><i class="bi bi-inbox"></i></div>
                                <div class="empty-state-title">No transactions found</div>
                                <div class="empty-state-message">Upload a bank statement to get started</div>
                                <a href="/upload" class="btn btn-primary">
                                    <i class="bi bi-cloud-upload me-2"></i>Upload Statement
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Mobile Card View -->
        <div class="mobile-transaction-list p-3">
            {% set current_date = namespace(value=None) %}
            {% for t in transactions %}
            {% set txn_date = t.date.strftime('%Y-%m-%d') %}
            {% if txn_date != current_date.value %}
            {% set current_date.value = txn_date %}
            <div class="mobile-date-header">
                <span><i class="bi bi-calendar3 me-2"></i>{{ t.date.strftime('%A, %b %d') }}</span>
            </div>
            {% endif %}
            <div class="mobile-transaction-card" data-id="{{ t.id }}" onclick="toggleMobileSelect(this, {{ t.id }})">
                <div class="mobile-card-header">
                    <span class="mobile-card-merchant">{{ t.description|merchant }}</span>
                    <span class="mobile-card-amount {% if t.amount >= 0 %}text-success{% else %}text-danger{% endif %}">
                        {% if t.amount >= 0 %}+{% endif %}${{ "%.2f"|format(t.amount|abs) }}
                    </span>
                </div>
                <div class="mobile-card-body">
                    <div class="mobile-card-meta">
                        <span class="mobile-card-date">
                            {{ t.date.strftime('%b %d') }}
                            {% if t.source %}Â· {{ t.source }}{% endif %}
                        </span>
                        <span class="mobile-card-description">{{ t.description }}</span>
                    </div>
                    <div class="mobile-card-actions" onclick="event.stopPropagation()">
                        {% set group_class = 'group-' + (t.category.group|lower|replace(' ', '-') if t.category else 'other') %}
                        <span class="badge category-badge {{ group_class }}" 
                              onclick="openCategoryModal({{ t.id }}, '{{ t.category.name if t.category else 'Uncategorized' }}')"
                              style="cursor: pointer; font-size: 0.7rem;">
                            {{ t.category.name if t.category else 'Uncategorized' }}
                        </span>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon"><i class="bi bi-inbox"></i></div>
                <div class="empty-state-title">No transactions found</div>
                <div class="empty-state-message">Upload a bank statement to get started</div>
                <a href="/upload" class="btn btn-primary">
                    <i class="bi bi-cloud-upload me-2"></i>Upload Statement
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Category Edit Modal -->
<div class="modal fade" id="categoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Change Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editTransactionId">
                <div class="mb-3">
                    <label class="form-label">Select Category</label>
                    <select id="categorySelect" class="form-select">
                        {% for cat in categories %}
                        <option value="{{ cat.id }}">{{ cat.name }} ({{ cat.group }})</option>
                        {% endfor %}
                    </select>
                </div>
                
                <hr class="my-3">
                
                <div class="mb-3">
                    <label class="form-label">Or Create New Category</label>
                    <div class="row g-2">
                        <div class="col-6">
                            <input type="text" id="newCategoryName" class="form-control" placeholder="Category name">
                        </div>
                        <div class="col-4">
                            <select id="newCategoryGroup" class="form-select">
                                <option value="Food">Food</option>
                                <option value="Transportation">Transportation</option>
                                <option value="Housing">Housing</option>
                                <option value="Entertainment">Entertainment</option>
                                <option value="Shopping">Shopping</option>
                                <option value="Financial">Financial</option>
                                <option value="Transfer">Transfer</option>
                                <option value="Health">Health</option>
                                <option value="Travel">Travel</option>
                                <option value="Work">Work</option>
                                <option value="Income">Income</option>
                                <option value="Cash">Cash</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="col-2">
                            <button type="button" class="btn btn-success w-100" onclick="createCategory()">
                                <i class="bi bi-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveCategory()">Save</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let categoryModal;
    let selectedTransactions = new Set();
    let isBulkMode = false;
    
    document.addEventListener('DOMContentLoaded', function() {
        categoryModal = new bootstrap.Modal(document.getElementById('categoryModal'));
    });
    
    // Bulk Selection Functions
    function updateSelection() {
        const checkboxes = document.querySelectorAll('.row-checkbox[data-id]:checked');
        selectedTransactions = new Set([...checkboxes].map(cb => parseInt(cb.dataset.id)));
        updateBulkBar();
    }
    
    function updateBulkBar() {
        const bar = document.getElementById('bulkSelectBar');
        const count = document.getElementById('selectedCount');
        count.textContent = selectedTransactions.size;
        
        if (selectedTransactions.size > 0) {
            bar.classList.add('active');
            // Highlight selected rows
            document.querySelectorAll('tr[data-id]').forEach(row => {
                if (selectedTransactions.has(parseInt(row.dataset.id))) {
                    row.classList.add('selected');
                } else {
                    row.classList.remove('selected');
                }
            });
        } else {
            bar.classList.remove('active');
            document.querySelectorAll('tr.selected').forEach(row => row.classList.remove('selected'));
        }
    }
    
    function toggleSelectAll(checked) {
        document.querySelectorAll('.row-checkbox[data-id]').forEach(cb => {
            cb.checked = checked;
        });
        updateSelection();
    }
    
    function clearSelection() {
        document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = false);
        selectedTransactions.clear();
        updateBulkBar();
    }
    
    function toggleMobileSelect(card, id) {
        card.classList.toggle('selected');
        if (card.classList.contains('selected')) {
            selectedTransactions.add(id);
        } else {
            selectedTransactions.delete(id);
        }
        updateBulkBar();
    }
    
    function openBulkCategoryModal() {
        if (selectedTransactions.size === 0) return;
        isBulkMode = true;
        document.getElementById('editTransactionId').value = [...selectedTransactions].join(',');
        categoryModal.show();
    }
    
    async function bulkDelete() {
        if (selectedTransactions.size === 0) return;
        if (!confirm(`Delete ${selectedTransactions.size} transactions?`)) return;
        
        try {
            for (const id of selectedTransactions) {
                await fetch(`/api/transactions/${id}`, { method: 'DELETE' });
            }
            location.reload();
        } catch (error) {
            alert('Error deleting: ' + error.message);
        }
    }
    
    function openCategoryModal(transactionId, currentCategory) {
        isBulkMode = false;
        document.getElementById('editTransactionId').value = transactionId;
        
        // Select current category
        const select = document.getElementById('categorySelect');
        for (let option of select.options) {
            if (option.text.startsWith(currentCategory + ' ')) {
                option.selected = true;
                break;
            }
        }
        
        categoryModal.show();
    }
    
    async function saveCategory() {
        const transactionIds = document.getElementById('editTransactionId').value;
        const categoryId = document.getElementById('categorySelect').value;
        const selectedOption = document.getElementById('categorySelect').selectedOptions[0];
        const newCategoryName = selectedOption ? selectedOption.text.split(' (')[0] : '';
        
        try {
            const ids = transactionIds.split(',').map(id => parseInt(id.trim()));
            
            for (const transactionId of ids) {
                const response = await fetch(`/api/transactions/${transactionId}/category`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ category_id: parseInt(categoryId) })
                });
                
                if (response.ok) {
                    const badge = document.querySelector(`[data-transaction-id="${transactionId}"]`);
                    if (badge) {
                        badge.textContent = newCategoryName;
                    }
                }
            }
            
            categoryModal.hide();
            if (isBulkMode) {
                clearSelection();
            }
        } catch (error) {
            alert('Error saving category: ' + error.message);
            categoryModal.hide();
        }
    }
    
    async function createCategory() {
        const name = document.getElementById('newCategoryName').value.trim();
        const group = document.getElementById('newCategoryGroup').value;
        
        if (!name) {
            alert('Please enter a category name');
            return;
        }
        
        try {
            const response = await fetch('/api/categories', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: name, group: group })
            });
            
            if (response.ok) {
                const newCat = await response.json();
                
                // Add to dropdown and select it
                const select = document.getElementById('categorySelect');
                const option = document.createElement('option');
                option.value = newCat.id;
                option.text = `${newCat.name} (${newCat.group})`;
                select.add(option);
                option.selected = true;
                
                // Clear input
                document.getElementById('newCategoryName').value = '';
                
                alert(`Category "${name}" created! Click Save to apply it.`);
            } else {
                const data = await response.json();
                alert('Error: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            alert('Error creating category: ' + error.message);
        }
    }
    
    async function deleteTransaction(transactionId) {
        if (!confirm('Delete this transaction?')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/transactions/${transactionId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                location.reload();
            } else {
                const data = await response.json();
                alert('Error: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            alert('Error deleting transaction: ' + error.message);
        }
    }
    
    async function toggleRecurring(transactionId, isRecurring) {
        try {
            const response = await fetch(`/api/transactions/${transactionId}/recurring`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ is_recurring: isRecurring })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                // Brief visual feedback
                const checkbox = document.getElementById('recurring-' + transactionId);
                if (checkbox) {
                    checkbox.parentElement.style.color = '#10b981';
                    setTimeout(() => {
                        checkbox.parentElement.style.color = '';
                    }, 1000);
                }
                console.log('Recurring status updated:', data.message);
            } else {
                // Revert checkbox on error
                const checkbox = document.getElementById('recurring-' + transactionId);
                if (checkbox) checkbox.checked = !isRecurring;
                alert('Error: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            // Revert checkbox on error
            const checkbox = document.getElementById('recurring-' + transactionId);
            if (checkbox) checkbox.checked = !isRecurring;
            alert('Error toggling recurring: ' + error.message);
        }
    }
    
    async function bulkRecategorize() {
        if (!confirm('Apply ML categorization to all uncategorized transactions?')) {
            return;
        }
        
        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Processing...';
        btn.disabled = true;
        
        try {
            const response = await fetch('/api/transactions/recategorize', {
                method: 'POST'
            });
            
            const data = await response.json();
            
            if (response.ok) {
                alert(data.message);
                if (data.count > 0) {
                    location.reload();
                }
            } else {
                alert('Error: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            alert('Error: ' + error.message);
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }
</script>
{% endblock %}
